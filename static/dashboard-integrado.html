<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Unique Equine | Recipient Center</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0a0a; --card: #141414; --gold: #d4af37; --neon: #00e676; --text: #e0e0e0; }
        body { font-family: 'Lato', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        h1, h2, h3 { font-family: 'Cinzel', serif; color: var(--gold); }
        
        .sidebar { width: 240px; background: #0f0f0f; border-right: 1px solid #222; padding: 20px; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 20px; overflow-y: auto; background: radial-gradient(circle at top right, #151515, #000); }
        
        input, select, button { background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 2px; width: 100%; margin-bottom: 5px; }
        button { cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-gold { background: linear-gradient(45deg, #8a701e, var(--gold)); color: black; border: none; }
        
        /* TABLE RECEPTORAS */
        .rec-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 20px; }
        .rec-table th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #333; }
        .rec-table td { padding: 8px; border-bottom: 1px solid #222; vertical-align: middle; }
        
        /* DESTAQUES DE CICLO */
        .badge-cycle { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; display: inline-block; width: 40px; text-align: center; }
        .cycle-ideal { background: rgba(0, 230, 118, 0.2); color: var(--neon); border: 1px solid var(--neon); box-shadow: 0 0 10px rgba(0,230,118,0.2); }
        .cycle-wait { background: #333; color: #888; }
        
        /* INPUTS RAPIDOS */
        .fast-input { background: transparent; border: none; border-bottom: 1px solid #333; color: var(--gold); text-align: center; }
        .fast-input:focus { border-color: var(--gold); outline: none; }
    </style>
</head>
<body>

    <div id="app" style="display:flex; width:100%; height:100%;">
        <div class="sidebar">
            <h3 style="text-align:center;">UNIQUE</h3>
            <p style="text-align:center; font-size:0.7rem; color:#666;">CENTRAL DE RECEPTORAS</p>
            <br>
            <button onclick="nav('diario')">üè• Toque Di√°rio</button>
            <button onclick="nav('te')">üß¨ Central de TE</button>
            <button onclick="location.reload()" style="background:#333; margin-top:auto;">Sair</button>
        </div>

        <div class="main">
            <div style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:15px; border-bottom:2px solid var(--gold);">
                <div>
                    <label style="font-size:0.7rem; color:#888;">PROPRIEDADE ATIVA</label>
                    <select id="prop-sel" onchange="carregarDados()" style="margin:0; font-size:1rem; color:var(--gold); border:none; background:transparent;">
                        <option value="Haras Morada">Haras Morada</option>
                        <option value="Fazenda Estrela">Fazenda Estrela</option>
                    </select>
                </div>
                <div>
                    <button class="btn-gold" style="width:auto; padding:10px 30px;" onclick="salvarDiario()">üíæ SALVAR EXAMES DO DIA</button>
                </div>
            </div>

            <div id="view-diario">
                <h3 style="margin-top:20px; color:#888;">Mapa de Controle Ginecol√≥gico</h3>
                <table class="rec-table">
                    <thead>
                        <tr>
                            <th>Receptora</th>
                            <th>Status Ciclo (D-Day)</th>
                            <th>OE</th>
                            <th>OD</th>
                            <th>Edema</th>
                            <th>Diag. / Conduta</th>
                        </tr>
                    </thead>
                    <tbody id="lista-diario"></tbody>
                </table>
                
                <div style="margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                    <small>Cadastro R√°pido:</small>
                    <div style="display:flex; gap:10px; max-width:400px;">
                        <input id="cad-nome" placeholder="Nome">
                        <button onclick="cadastrar()" style="width:auto;">Add Receptora</button>
                    </div>
                </div>
            </div>

            <div id="view-te" style="display:none;">
                <h3 style="margin-top:20px; color:#888;">Receptoras Sincronizadas (D5 a D8)</h3>
                <p style="font-size:0.8rem; color:#666;">Abaixo est√£o as √©guas prontas para receber embri√£o hoje.</p>
                <table class="rec-table">
                    <thead><tr><th>Receptora</th><th>Ciclo</th><th>√öltimo Exame</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="lista-te"></tbody>
                </table>
            </div>

        </div>
    </div>

    <script>
        const API = '/api/receptoras';
        let token = localStorage.getItem('token');

        if(!token) {
            fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:'admin@haras.com', password:'admin123'})})
            .then(r=>r.json()).then(d=>{ localStorage.setItem('token', d.token); token=d.token; carregarDados(); });
        } else {
            carregarDados();
        }

        function nav(v) {
            document.getElementById('view-diario').style.display = v==='diario'?'block':'none';
            document.getElementById('view-te').style.display = v==='te'?'block':'none';
        }

        async function carregarDados() {
            const prop = document.getElementById('prop-sel').value;
            const res = await fetch(`${API}?propriedade=${encodeURI(prop)}&categoria=Receptora`, {headers:{'Authorization':`Bearer ${token}`}});
            const lista = await res.json();
            
            renderDiario(lista);
            renderTE(lista);
        }

        function renderDiario(lista) {
            const tb = document.getElementById('lista-diario');
            tb.innerHTML = "";
            lista.forEach(r => {
                let badgeClass = 'cycle-wait';
                // Se for D5 a D8, destaca
                if(r.ciclo.startsWith('D') && parseInt(r.ciclo.substring(1)) >= 5 && parseInt(r.ciclo.substring(1)) <= 8) {
                    badgeClass = 'cycle-ideal';
                }

                tb.innerHTML += `
                    <tr class="row-exame" data-id="${r.id}">
                        <td><strong>${r.nome}</strong><br><small style="color:#666;">${r.registro || ''}</small></td>
                        <td><span class="badge-cycle ${badgeClass}">${r.ciclo}</span></td>
                        <td><input class="fast-input inp-oe" placeholder="-"></td>
                        <td><input class="fast-input inp-od" placeholder="-"></td>
                        <td><input class="fast-input inp-ed" placeholder="0-3"></td>
                        <td><input class="fast-input inp-di" placeholder="Ex: Ovulou, Inovular..."></td>
                    </tr>`;
            });
        }

        function renderTE(lista) {
            const tb = document.getElementById('lista-te');
            tb.innerHTML = "";
            // Filtra so as boas
            const aptas = lista.filter(r => r.ciclo.startsWith('D') && parseInt(r.ciclo.substring(1)) >= 4);
            
            if(aptas.length === 0) tb.innerHTML = "<tr><td colspan='4'>Nenhuma receptora sincronizada hoje.</td></tr>";

            aptas.forEach(r => {
                tb.innerHTML += `
                    <tr>
                        <td>${r.nome}</td>
                        <td><span class="badge-cycle cycle-ideal">${r.ciclo}</span></td>
                        <td>${r.resumo}</td>
                        <td><button style="padding:5px 10px; width:auto;" onclick="alert('Funcao Inovular aqui')">üß¨ USAR</button></td>
                    </tr>`;
            });
        }

        async function salvarDiario() {
            const rows = document.querySelectorAll('.row-exame');
            const payload = [];
            rows.forEach(r => {
                const id = r.getAttribute('data-id');
                const oe = r.querySelector('.inp-oe').value;
                const od = r.querySelector('.inp-od').value;
                const ed = r.querySelector('.inp-ed').value;
                const di = r.querySelector('.inp-di').value;
                
                if(oe || od || di) payload.push({id, oe, od, edema:ed, diag:di});
            });
            
            if(payload.length===0) return;
            
            await fetch(API+'/exames/lote', {
                method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${token}`},
                body: JSON.stringify(payload)
            });
            alert("Dados Salvos! Ciclos Atualizados.");
            carregarDados();
        }

        async function cadastrar() {
            const nome = document.getElementById('cad-nome').value;
            const prop = document.getElementById('prop-sel').value;
            await fetch(API, {
                method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${token}`},
                body: JSON.stringify({nome, propriedade:prop, categoria:'Receptora'})
            });
            carregarDados();
        }
    </script>
</body>
</html>
